#!/usr/bin/env tclsh
# 
# Server for remote SKILL script execution
# Based on design by A.D.Beckett (Cadence Design Systems Ltd)
# 

# Set debug mode (1 for more verbose output)
set debug 1

if [info exists env(SKILLSERVPORT)] {
  set port $env(SKILLSERVPORT)
} else {
  set port 8123
}

proc listener {channel addr port} {
  global debug
  if {$debug} {
    puts stderr "New connection from $addr:$port on channel $channel"
  }
  puts "$channel abSkillServerConnection(\"$addr\" \"$port\")"
  flush stdout
  fconfigure $channel -buffering line
  fileevent $channel readable [list sendToDFII $channel]
}

proc sendToDFII {channel} {
  global debug
  if {[eof $channel] || [catch {gets $channel line}]} {
    # end of file
    if {$debug} {
      puts stderr "Connection closed for channel $channel"
    }
    close $channel
  } else {
    if {$debug} {
      puts stderr "Received from client: $line"
    }
    puts "$channel $line"
    flush stdout
  }
}
  
proc sendBack {} {
  global debug
  if {[catch {gets stdin line} result]} {
    if {$debug} {
      puts stderr "Error reading from stdin: $result"
    }
    return
  }
  
  if {[string length $line] == 0} {
    if {$debug} {
      puts stderr "Warning: Received empty line from Cadence"
    }
    return
  }
  
  if {[regexp {^(\w+) (.*)$} $line match channel result]} {
    if {$debug} {
      puts stderr "Sending to client ($channel): $result"
    }
    
    # Check if the channel is still open
    if {[catch {puts $channel $result; flush $channel} err]} {
      puts stderr "Error sending to client: $err"
    }
  } else {
    if {$debug} {
      puts stderr "Malformed response: $line"
    }
  }
}

puts stderr "SKILL Server starting on port $port..."
fconfigure stdin -buffering line
fileevent stdin readable sendBack

# Check if we can open the socket - explicitly bind to all interfaces with ""
if {[catch {socket -server listener "" $port} err]} {
  puts stderr "ERROR: Failed to open server socket on port $port: $err"
  exit 1
}

puts stderr "SKILL Server listening on port $port (all interfaces)"
vwait forever
